name: Tests

on:
  pull_request:
    branches: [ main, develop ]
    paths-ignore:
      - 'landing/**'
  push:
    branches: [ main, develop ]
    paths-ignore:
      - 'landing/**'

jobs:
  backend-tests:
    name: Backend Tests (Go)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache-dependency-path: server/go.sum
      
      - name: Install dependencies
        working-directory: ./server
        run: go mod download
      
      - name: Run tests with coverage
        working-directory: ./server/app
        run: |
          go test -v -coverprofile=coverage.out .
          go tool cover -func=coverage.out
      
      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./server/app/coverage.out
          flags: backend
          fail_ci_if_error: false

  client-tests:
    name: Client Tests (Flutter)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.6'
          channel: 'stable'
          cache: true
      
      - name: Install dependencies
        working-directory: ./client
        run: flutter pub get
      
      - name: Run build_runner
        working-directory: ./client
        run: dart run build_runner build --delete-conflicting-outputs
      
      - name: Run tests with coverage
        working-directory: ./client
        run: flutter test --coverage
      
      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./client/coverage/lcov.info
          flags: client
          fail_ci_if_error: false

  e2e-tests:
    name: E2E Tests (Playwright)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Start test environment
        run: docker compose -f docker-compose.test.yml up -d
      
      - name: Wait for services to be healthy
        run: |
          echo "Waiting for server to be ready..."
          timeout 60 bash -c 'until curl -f http://localhost:8091/health; do sleep 2; done'
          echo "âœ… Server is ready"
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: e2e-tests/package-lock.json
      
      - name: Install Playwright dependencies
        working-directory: ./e2e-tests
        run: |
          npm ci
          npx playwright install --with-deps chromium
      
      - name: Run E2E tests
        working-directory: ./e2e-tests
        env:
          API_URL: http://localhost:8091
        run: npx playwright test
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: e2e-tests/playwright-report/
          retention-days: 7
      
      - name: Show logs on failure
        if: failure()
        run: |
          echo "=== Server logs ==="
          docker compose -f docker-compose.test.yml logs server
          echo "=== Database logs ==="
          docker compose -f docker-compose.test.yml logs db
      
      - name: Cleanup
        if: always()
        run: docker compose -f docker-compose.test.yml down -v

  video-demo-test:
    name: Video Demo Test (Playwright)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Server Image (Cache)
        uses: docker/build-push-action@v5
        with:
          context: ./server
          push: false
          load: true
          tags: keda-server:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build Client Image (Cache)
        uses: docker/build-push-action@v5
        with:
          context: ./client
          push: false
          load: true
          tags: keda-client:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: video-demo/package-lock.json

      - name: Run video generation test
        working-directory: ./video-demo
        run: ./run.sh

      - name: Upload video artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: demo-video
          path: landing/assets/demo.webm
          retention-days: 7

  cleanup:
    if: always()
    needs: [backend-tests, client-tests, e2e-tests, video-demo-test]
    runs-on: ubuntu-latest
    steps:
      - name: Cleanup
        run: echo "Done"