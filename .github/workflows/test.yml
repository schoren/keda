name: Tests

on:
  pull_request:
    branches: [ main, develop ]
    paths-ignore:
      - 'landing/**'
  push:
    branches: [ main, develop ]
    paths-ignore:
      - 'landing/**'

jobs:
  setup-playwright:
    name: Setup Playwright (${{ matrix.project }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - project: video-demo
            path: video-demo
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: ${{ matrix.path }}/package-lock.json
      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: ${{ matrix.path }}/node_modules
          key: ${{ runner.os }}-node-${{ matrix.project }}-${{ hashFiles(format('{0}/package-lock.json', matrix.path)) }}
      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles(format('{0}/package-lock.json', matrix.path)) }}
          restore-keys: |
            ${{ runner.os }}-playwright-
      - name: Install dependencies
        working-directory: ./${{ matrix.path }}
        run: |
          npm ci
          npx playwright install --with-deps chromium

  backend-tests:
    name: Backend Tests (Go)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache-dependency-path: server/go.sum
      
      - name: Install dependencies
        working-directory: ./server
        run: go mod download
      
      - name: Run tests with coverage
        working-directory: ./server/app
        run: |
          go test -v -coverprofile=coverage.out .
          go tool cover -func=coverage.out
      
      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./server/app/coverage.out
          flags: backend
          fail_ci_if_error: false

  security-gosec:
    name: Security - Gosec
    runs-on: ubuntu-latest
    permissions:
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Run Gosec Security Scanner
        uses: securego/gosec@master
        with:
          args: '-no-fail -fmt sarif -out results.sarif ./server/...'
      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: results.sarif

  security-trivy-client:
    name: Security - Trivy Client
    runs-on: ubuntu-latest
    permissions:
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Run Trivy for Client
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: './client'
          format: 'sarif'
          output: 'trivy-results-client.sarif'
          scanners: 'vuln,secret,misconfig'
          exit-code: '0'
          ignore-unfixed: true
      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-results-client.sarif

  security-trivy-server:
    name: Security - Trivy Server
    runs-on: ubuntu-latest
    permissions:
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Run Trivy for Server
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: './server'
          format: 'sarif'
          output: 'trivy-results-server.sarif'
          scanners: 'vuln,secret,misconfig'
          exit-code: '0'
          ignore-unfixed: true
      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-results-server.sarif

  security-mobsf:
    name: Security - MobSF
    runs-on: ubuntu-latest
    permissions:
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: mobsfscan
        uses: MobSF/mobsfscan@main
        with:
          args: '. --sarif --output results.sarif || true'
      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: results.sarif

  security-landing:
    name: Security - Landing (npm audit)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Run npm audit (Landing)
        working-directory: ./landing
        run: npm audit

  lint-backend:
    name: Lint Backend (Go)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
      - name: Install golangci-lint
        uses: golangci/golangci-lint-action@v9
        with:
          version: v2.6.1
          working-directory: server

  lint-client:
    name: Lint Client (Flutter)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.6'
          channel: 'stable'
      - name: Install dependencies
        working-directory: ./client
        run: flutter pub get
      - name: Analyze
        working-directory: ./client
        run: flutter analyze || echo "::warning::Flutter analyzer found issues"

  client-tests:
    name: Client Tests (Flutter)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.6'
          channel: 'stable'
          cache: true
      
      - name: Install dependencies
        working-directory: ./client
        run: flutter pub get
      
      - name: Run build_runner
        working-directory: ./client
        run: dart run build_runner build --delete-conflicting-outputs
      
      - name: Run tests with coverage
        working-directory: ./client
        run: flutter test --coverage
      
      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./client/coverage/lcov.info
          flags: client
          fail_ci_if_error: false

  build-images:
    name: Build ${{ matrix.image }} Image
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - image: server
            context: ./server
          - image: client
            context: ./client
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build and push to registry
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.context }}
          push: true
          tags: schoren/keda-${{ matrix.image }}:${{ github.sha }}

  video-demo-test:
    name: Video Demo Test (Playwright)
    needs: [build-images, setup-playwright]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: video-demo/node_modules
          key: ${{ runner.os }}-node-video-demo-${{ hashFiles('video-demo/package-lock.json') }}

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('video-demo/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: Install Playwright dependencies (Cache Check)
        working-directory: ./video-demo
        run: |
          if [ ! -d "node_modules" ]; then npm ci; fi
          npx playwright install --with-deps chromium

      - name: Run video generation
        working-directory: ./video-demo
        env:
          SERVER_IMAGE: schoren/keda-server:${{ github.sha }}
          CLIENT_IMAGE: schoren/keda-client:${{ github.sha }}
        run: ./run.sh

      - name: Upload video artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: demo-video
          path: video-demo/test-results/demo.webm
          retention-days: 7

  cleanup:
    if: always()
    needs: 
      - backend-tests
      - client-tests
      - video-demo-test
      - lint-backend
      - lint-client
      - security-gosec
      - security-trivy-client
      - security-trivy-server
      - security-mobsf
      - security-landing
    runs-on: ubuntu-latest
    steps:
      - name: Cleanup
        run: echo "Done"