name: Tests

on:
  pull_request:
    branches: [ main, develop ]
    paths-ignore:
      - 'landing/**'
  push:
    branches: [ main, develop ]
    paths-ignore:
      - 'landing/**'

permissions:
  contents: read

jobs:
  setup-playwright:
    name: Setup Playwright (${{ matrix.project }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - project: preview-generator
            path: preview-generator
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: ${{ matrix.path }}/package-lock.json
      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: ${{ matrix.path }}/node_modules
          key: ${{ runner.os }}-node-${{ matrix.project }}-${{ hashFiles(format('{0}/package-lock.json', matrix.path)) }}
      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles(format('{0}/package-lock.json', matrix.path)) }}
          restore-keys: |
            ${{ runner.os }}-playwright-
      - name: Install dependencies
        working-directory: ./${{ matrix.path }}
        run: |
          npm ci
          npx playwright install --with-deps chromium

  backend-tests:
    name: Backend Tests (Go)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache-dependency-path: server/go.sum
      
      - name: Install dependencies
        working-directory: ./server
        run: go mod download
      
      - name: Run tests with coverage
        working-directory: ./server/app
        run: |
          go test -v -coverprofile=coverage.out .
          go tool cover -func=coverage.out
      
      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./server/app/coverage.out
          flags: backend
          fail_ci_if_error: false

  security-gosec:
    name: Security - Gosec
    runs-on: ubuntu-latest
    permissions:
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Run Gosec Security Scanner
        uses: securego/gosec@master
        with:
          args: '-no-fail -fmt sarif -out results.sarif ./server/...'
      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: results.sarif

  security-trivy-client:
    name: Security - Trivy Client
    runs-on: ubuntu-latest
    permissions:
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Run Trivy for Client
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: './client'
          format: 'sarif'
          output: 'trivy-results-client.sarif'
          scanners: 'vuln,secret,misconfig'
          exit-code: '0'
          ignore-unfixed: true
      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-results-client.sarif

  security-trivy-server:
    name: Security - Trivy Server
    runs-on: ubuntu-latest
    permissions:
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Run Trivy for Server
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: './server'
          format: 'sarif'
          output: 'trivy-results-server.sarif'
          scanners: 'vuln,secret,misconfig'
          exit-code: '0'
          ignore-unfixed: true
      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-results-server.sarif

  security-mobsf:
    name: Security - MobSF
    runs-on: ubuntu-latest
    permissions:
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: mobsfscan
        uses: MobSF/mobsfscan@main
        with:
          args: '. --sarif --output results.sarif || true'
      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: results.sarif

  security-landing:
    name: Security - Landing (npm audit)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Run npm audit (Landing)
        working-directory: ./landing
        run: npm audit

  lint-backend:
    name: Lint Backend (Go)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
      - name: Install golangci-lint
        uses: golangci/golangci-lint-action@v9
        with:
          version: v2.6.1
          working-directory: server

  warmup-client-caches:
    name: Setup Android & Flutter Cache
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
          cache: 'gradle'
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.6'
          channel: 'stable'
          cache: true
      - name: Cache Flutter dependencies
        uses: actions/cache@v4
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-pub-${{ hashFiles('client/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-
      - name: Install dependencies
        working-directory: ./client
        run: flutter pub get

  lint-client:
    name: Lint Client (Flutter)
    needs: [warmup-client-caches]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.6'
          channel: 'stable'
      - name: Cache Flutter dependencies
        uses: actions/cache@v4
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-pub-${{ hashFiles('client/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-

      - name: Install dependencies
        working-directory: ./client
        run: flutter pub get
      - name: Analyze
        working-directory: ./client
        run: flutter analyze || echo "::warning::Flutter analyzer found issues"

  client-tests:
    name: Client Tests (Flutter)
    needs: [warmup-client-caches]
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.6'
          channel: 'stable'
          cache: true
      
      - name: Install dependencies
        working-directory: ./client
        run: flutter pub get
      
      - name: Run build_runner
        working-directory: ./client
        run: dart run build_runner build --delete-conflicting-outputs
      
      - name: Run tests with coverage
        working-directory: ./client
        run: flutter test --coverage
      
      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./client/coverage/lcov.info
          flags: client
          fail_ci_if_error: false

  build-android:
    name: Build Android APK
    needs: [warmup-client-caches]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
          cache: 'gradle'
      
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.6'
          channel: 'stable'
          cache: true
      
      - name: Cache Flutter dependencies
        uses: actions/cache@v4
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-pub-${{ hashFiles('client/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-

      - name: Install dependencies
        working-directory: ./client
        run: flutter pub get
      
      - name: Build APK (Debug)
        working-directory: ./client
        run: flutter build apk --debug
      
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: app-debug.apk
          path: client/build/app/outputs/flutter-apk/app-debug.apk
          retention-days: 7

  build-images:
    name: Build ${{ matrix.image }} Image
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - image: server
            context: ./server
          - image: client
            context: ./client
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build and push to registry
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.context }}
          push: true
          tags: schoren/keda-${{ matrix.image }}:${{ github.sha }}

  preview-generator-test:
    name: Video Demo Test (Playwright)
    needs: [build-images, setup-playwright]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: preview-generator/node_modules
          key: ${{ runner.os }}-node-preview-generator-${{ hashFiles('preview-generator/package-lock.json') }}

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('preview-generator/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: Install Playwright dependencies (Cache Check)
        working-directory: ./preview-generator
        run: |
          if [ ! -d "node_modules" ]; then npm ci; fi
          npx playwright install --with-deps chromium

      - name: Run video generation
        working-directory: ./preview-generator
        env:
          SERVER_IMAGE: schoren/keda-server:${{ github.sha }}
          CLIENT_IMAGE: schoren/keda-client:${{ github.sha }}
        run: ./run.sh

      - name: Upload marketing assets
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: marketing-assets
          path: preview-generator/generated-assets/
          retention-days: 7

  android-integration-test:
    name: Android Integration Test (Headless)
    needs: [warmup-client-caches]
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
          cache: 'gradle'

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.6'
          channel: 'stable'
          cache: true

      - name: Cache Flutter dependencies
        uses: actions/cache@v4
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-pub-${{ hashFiles('client/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-

      - name: Install dependencies
        working-directory: ./client
        run: flutter pub get

      - name: Run Integration Tests (Headless Emulator)
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 29
          target: google_apis
          arch: x86_64
          profile: Nexus 6
          working-directory: ./client
          script: flutter test integration_test/app_test.dart --dart-define=TEST_MODE=true --dart-define=INTEGRATION_TEST=true --dart-define=MOCK_DATA=true

  cleanup:
    if: always()
    needs: 
      - backend-tests
      - client-tests
      - preview-generator-test
      - lint-backend
      - lint-client
      - security-gosec
      - security-trivy-client
      - security-trivy-server
      - security-mobsf
      - security-landing
      - android-integration-test
      - build-android
    runs-on: ubuntu-latest
    steps:
      - name: Cleanup
        run: echo "Done"
